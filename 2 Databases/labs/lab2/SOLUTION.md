# Пример решения ЛР2 по Базам Данных

Вариант `5313`

### Внимание! У разных вариантов разный текст задания!

Составить запросы на языке SQL (пункты 1-7):

### Задание 1

Сделать запрос для получения атрибутов из указанных таблиц, применив фильтры по указанным условиям:  
    Таблицы: Н_ОЦЕНКИ, Н_ВЕДОМОСТИ.  
    Вывести атрибуты: Н_ОЦЕНКИ.КОД, Н_ВЕДОМОСТИ.ДАТА.  
    Фильтры (AND):  
    a) Н_ОЦЕНКИ.КОД > 2.  
    b) Н_ВЕДОМОСТИ.ИД = 1250972.  
    Вид соединения: INNER JOIN. 

Необходимо вывести некоторые поля ведомости, где id = 1250972 и код самой оценки выше 2. 

```sql
SELECT 
	Н_ОЦЕНКИ.КОД, 
	Н_ВЕДОМОСТИ.ДАТА 
FROM Н_ВЕДОМОСТИ 
	INNER JOIN Н_ОЦЕНКИ 
		ON Н_ВЕДОМОСТИ.ОЦЕНКА = Н_ОЦЕНКИ.КОД 
WHERE 
	Н_ОЦЕНКИ.КОД > '2' 
	AND Н_ВЕДОМОСТИ.ИД = '1250972';
```

Результат:

```
        ДАТА         | КОД 
---------------------+-----
 2010-06-18 00:00:00 | 5
```

### Задание 2

Сделать запрос для получения атрибутов из указанных таблиц, применив фильтры по указанным условиям:  
    Таблицы: Н_ЛЮДИ, Н_ОБУЧЕНИЯ, Н_УЧЕНИКИ.  
    Вывести атрибуты: Н_ЛЮДИ.ИД, Н_ОБУЧЕНИЯ.НЗК, Н_УЧЕНИКИ.НАЧАЛО.  
    Фильтры: (AND)  
    a) Н_ЛЮДИ.ИМЯ > Владимир.  
    b) Н_ОБУЧЕНИЯ.НЗК > 001000.  
    c) Н_УЧЕНИКИ.ГРУППА < 3100.  
    Вид соединения: INNER JOIN.  

Необходимо вывести id человека, нзк с обучения и начало с учеников с таблицы обучения

Связующий ключ (FK) ИД ЧЛВК_ИД и ИД

```sql
SELECT Н_ЛЮДИ.ИД,
       Н_ОБУЧЕНИЯ.НЗК,
       Н_УЧЕНИКИ.НАЧАЛО
FROM Н_ОБУЧЕНИЯ
    INNER JOIN Н_ЛЮДИ
        ON Н_ЛЮДИ.ИД = Н_ОБУЧЕНИЯ.ЧЛВК_ИД
    INNER JOIN Н_УЧЕНИКИ
        ON Н_УЧЕНИКИ.ИД = Н_ОБУЧЕНИЯ.ЧЛВК_ИД
WHERE Н_ЛЮДИ.ИМЯ > 'Владимир'
      AND Н_ОБУЧЕНИЯ.НЗК > '001000'
      AND Н_УЧЕНИКИ.ГРУППА < '3100';
```

#### Реузльтат

```
  ИД   |  НЗК   |       НАЧАЛО           
--------+--------+---------------------  
112698 | 945038 | 2006-07-06 00:00:00  
111721 | 941020 | 2006-07-04 00:00:00  
120234 | 038745 | 2006-09-01 00:00:00  
120235 | 001472 | 2006-09-01 00:00:00  
120255 | 001280 | 2006-09-01 00:00:00  
120256 | 001369 | 2006-09-01 00:00:00  
120258 | 011404 | 2006-09-01 00:00:00  
120232 | 001463 | 2006-09-01 00:00:00  
120077 | 006098 | 2006-09-01 00:00:00  
120107 | 001271 | 2006-09-01 00:00:00  
120109 | 001432 | 2006-09-01 00:00:00  
120139 | 001373 | 2006-09-01 00:00:00  
120141 | 001374 | 2006-09-01 00:00:00  
120145 | 001436 | 2006-09-01 00:00:00  
120153 | 001378 | 2006-09-01 00:00:00  
120154 | 001437 | 2006-09-01 00:00:00  
120158 | 001439 | 2006-09-01 00:00:00  
120159 | 001440 | 2006-09-01 00:00:00  
120160 | 001441 | 2006-09-01 00:00:00  
120165 | 007082 | 2006-09-01 00:00:00  
120168 | 007088 | 2006-09-01 00:00:00  
120169 | 007086 | 2006-09-01 00:00:00  
120170 | 001298 | 2006-09-01 00:00:00  
120184 | 022151 | 2006-09-01 00:00:00  
120185 | 001400 | 2006-09-01 00:00:00  
120186 | 001399 | 2006-09-01 00:00:00  
120187 | 001398 | 2006-09-01 00:00:00  
120190 | 001395 | 2006-09-01 00:00:00  
120192 | 001393 | 2006-09-01 00:00:00  
120197 | 001388 | 2006-09-01 00:00:00  
120198 | 001387 | 2006-09-01 00:00:00  
120222 | 001446 | 2006-09-01 00:00:00  
120223 | 001447 | 2006-09-01 00:00:00  
120224 | 068221 | 2006-09-01 00:00:00  
120227 | 001448 | 2006-09-01 00:00:00  
120231 | 011437 | 2006-09-01 00:00:00  
117708 | 988191 | 2006-09-01 00:00:00  
117775 | 988202 | 2006-09-01 00:00:00  
117784 | 981395 | 2006-09-01 00:00:00  
116494 | 981105 | 2006-09-01 00:00:00  
116495 | 981132 | 2006-09-01 00:00:00  
116497 | 981118 | 2006-09-01 00:00:00  
116471 | 981025 | 2006-09-01 00:00:00  
116480 | 981116 | 2006-09-01 00:00:00  
116483 | 981089 | 2006-09-01 00:00:00  
116484 | 981014 | 2006-09-01 00:00:00  
116485 | 981015 | 2006-09-01 00:00:00  
116487 | 981104 | 2006-09-01 00:00:00  
116135 | 974028 | 2006-07-04 00:00:00  
116233 | 977119 | 2006-09-01 00:00:00  
110139 | 931157 | 2006-09-01 00:00:00  
110141 | 931159 | 2006-09-01 00:00:00  
120169 | 018322 | 2006-09-01 00:00:00  
121458 | 010090 | 2006-09-01 00:00:00  
141721 | 061304 | 2007-09-01 00:00:00  
142342 | 108134 | 2007-09-01 00:00:00  
163484 | 111439 | 2008-09-01 00:00:00  
142380 | 098171 | 2007-09-01 00:00:00  
142381 | 061196 | 2007-09-01 00:00:00  
142384 | 061199 | 2007-09-01 00:00:00  
142109 | 065039 | 2007-09-01 00:00:00  
142362 | 061201 | 2007-09-01 00:00:00  
142364 | 061203 | 2007-09-01 00:00:00  
142365 | 061204 | 2007-09-01 00:00:00  
142389 | 061101 | 2007-09-01 00:00:00  
142390 | 061102 | 2007-09-01 00:00:00  
142376 | 061121 | 2007-09-01 00:00:00  
142392 | 102094 | 2007-09-01 00:00:00  
142309 | 061260 | 2007-09-01 00:00:00  
142394 | 061106 | 2007-09-01 00:00:00  
142378 | 061129 | 2007-09-01 00:00:00  
142379 | 061123 | 2007-09-01 00:00:00  
142395 | 061107 | 2007-09-01 00:00:00  
142357 | 061124 | 2007-09-01 00:00:00  
142306 | 061146 | 2007-09-01 00:00:00  
134198 | 041018 | 2007-09-01 00:00:00  
145931 | 071134 | 2007-09-01 00:00:00  
145899 | 071128 | 2007-09-01 00:00:00  
142360 | 080721 | 2007-09-01 00:00:00  
145901 | 071129 | 2007-09-01 00:00:00  
145911 | 071130 | 2007-09-01 00:00:00  
145983 | 071144 | 2007-09-01 00:00:00  
142358 | 061125 | 2007-09-01 00:00:00  
142359 | 061126 | 2007-09-01 00:00:00  
142325 | 061149 | 2007-09-01 00:00:00  
142328 | 061263 | 2007-09-01 00:00:00  
142341 | 061152 | 2007-09-01 00:00:00  
142207 | 061067 | 2007-09-01 00:00:00  
145897 | 075059 | 2007-09-01 00:00:00
```

### Задание 3

Вывести число отчеств без учета повторений.  При составлении запроса нельзя использовать DISTINCT.

```sql
SELECT COUNT(*)
FROM (
	SELECT ОТЧЕСТВО
	FROM Н_ЛЮДИ
	GROUP BY ОТЧЕСТВО
);
```

Результат:

```
 count 
-------
   353
(1 строка)

```

### Задание 4

Выдать различные фамилии людей и число людей с каждой из этих фамилий, ограничив список фамилиями, встречающимися ровно 10 раз на ФКТИУ. Для реализации использовать подзапрос.

ФКТИУ = КТиУ

Что от нас требуется вывести:  фамилии, число этих фамилий.
Критерий: ровно 10 раз на КТиУ. Эту задачу нужно решить с помощью JOIN'ов и вложенных запросов:

![](Pasted%20image%2020250331110807.png)


```sql
SELECT 
    Н_ЛЮДИ.ФАМИЛИЯ
FROM Н_УЧЕНИКИ
    INNER JOIN Н_ПЛАНЫ 
	    ON Н_ПЛАНЫ.ИД = Н_УЧЕНИКИ.ПЛАН_ИД
    INNER JOIN Н_ОТДЕЛЫ 
	    ON Н_ОТДЕЛЫ.ИД = Н_ПЛАНЫ.ОТД_ИД
    INNER JOIN Н_ЛЮДИ 
	    ON Н_ЛЮДИ.ИД = Н_УЧЕНИКИ.ЧЛВК_ИД
WHERE 
    Н_ОТДЕЛЫ.КОРОТКОЕ_ИМЯ = 'КТиУ'
GROUP BY 
    Н_ЛЮДИ.ФАМИЛИЯ
HAVING 
    COUNT(*) = 10;
```

```
   ФАМИЛИЯ     | КОЛИЧЕСТВО (опционально)
----------------+------------
 Безруков       |         10
 Новикова       |         10
 Алексеенко     |         10
 Путинцев       |         10
 Сиднин         |         10
 Шадже          |         10
 Булыго         |         10
 Логвиненко     |         10
 Кузьмина       |         10
 Бессонов       |         10
 Малин          |         10
 Гречин         |         10
 Митров         |         10
 Абдурагимов    |         10
 Бокарев        |         10
 Курбанова      |         10
 Ху             |         10
 ...........................
```

```sql
SELECT 
    Н_ЛЮДИ.ФАМИЛИЯ,
    COUNT(*) AS КОЛИЧЕСТВО_ЛЮДЕЙ_С_ТАКОЙ_ФАМИЛИЕЙ
FROM 
	Н_ЛЮДИ
WHERE 
    Н_ЛЮДИ.ФАМИЛИЯ IN (
        SELECT 
            Н_ЛЮДИ.ФАМИЛИЯ
        FROM 
            Н_УЧЕНИКИ
            INNER JOIN Н_ПЛАНЫ 
	            ON Н_ПЛАНЫ.ИД = Н_УЧЕНИКИ.ПЛАН_ИД
            INNER JOIN Н_ОТДЕЛЫ 
	            ON Н_ОТДЕЛЫ.ИД = Н_ПЛАНЫ.ОТД_ИД
            INNER JOIN Н_ЛЮДИ 
	            ON Н_ЛЮДИ.ИД = Н_УЧЕНИКИ.ЧЛВК_ИД
        WHERE 
            Н_ОТДЕЛЫ.КОРОТКОЕ_ИМЯ = 'КТиУ'
        GROUP BY 
            Н_ЛЮДИ.ФАМИЛИЯ
        HAVING 
            COUNT(*) = 10
    )
GROUP BY 
    Н_ЛЮДИ.ФАМИЛИЯ;
```

### Задание 5

Выведите таблицу со средним возрастом студентов во всех группах (Группа, Средний возраст), где средний возраст равен (?) минимальному возрасту в группе 1100.

```sql
WITH МИН_ВОЗРАСТ AS (
		SELECT DATE_PART('year', AGE(CURRENT_DATE, Н_ЛЮДИ.ДАТА_РОЖДЕНИЯ)) AS ВОЗРАСТ
	FROM Н_УЧЕНИКИ 
		INNER JOIN Н_ЛЮДИ 
			ON Н_ЛЮДИ.ИД = Н_УЧЕНИКИ.ЧЛВК_ИД 
	WHERE 
		ГРУППА = '1100'
		AND DATE_PART('year', AGE(CURRENT_DATE, Н_ЛЮДИ.ДАТА_РОЖДЕНИЯ)) > 20
	GROUP BY 
		ВОЗРАСТ
	ORDER BY 
		ВОЗРАСТ ASC 
	LIMIT 1
)

SELECT
	Н_УЧЕНИКИ.ГРУППА,
	ROUND(AVG(DATE_PART('year', AGE(CURRENT_DATE, Н_ЛЮДИ.ДАТА_РОЖДЕНИЯ)))) AS СР_ВОЗРАСТ
FROM 
    Н_УЧЕНИКИ 
    INNER JOIN Н_ЛЮДИ 
	    ON Н_ЛЮДИ.ИД = Н_УЧЕНИКИ.ЧЛВК_ИД
	CROSS JOIN 
		МИН_ВОЗРАСТ
GROUP BY
    ГРУППА, МИН_ВОЗРАСТ.ВОЗРАСТ
HAVING
	ROUND(AVG(DATE_PART('year', AGE(CURRENT_DATE, Н_ЛЮДИ.ДАТА_РОЖДЕНИЯ)))) = МИН_ВОЗРАСТ.ВОЗРАСТ
ORDER BY
    ГРУППА;
```

**Примечание**: чтобы результат был непустым, сделал условие >20 (по умолчанию там 13) и округлил ср. возраст групп

### Задание 6

Получить список студентов, зачисленных ровно первого сентября 2012 года на первый курс заочной формы обучения. В результат включить:  
- номер группы;  
- номер, фамилию, имя и отчество студента;  
- номер и состояние пункта приказа;  
- Для реализации использовать подзапрос с EXISTS.


Группа | ису | ф | и | о | номер приказа | состояние приказа

![](Pasted%20image%2020250401121357.png)

Запрос с результатами:

```sql
SELECT DISTINCT
	Н_УЧЕНИКИ.ГРУППА,
	Н_ЛЮДИ.ИД,
	Н_ЛЮДИ.ИМЯ,
	Н_ЛЮДИ.ФАМИЛИЯ,
	Н_ЛЮДИ.ОТЧЕСТВО,
	Н_ФОРМЫ_ОБУЧЕНИЯ.НАИМЕНОВАНИЕ,
	Н_ПЛАНЫ.ИД,
	Н_УЧЕНИКИ.СОСТОЯНИЕ
FROM Н_УЧЕНИКИ
	INNER JOIN Н_ПЛАНЫ
		ON Н_ПЛАНЫ.ИД = Н_УЧЕНИКИ.ПЛАН_ИД
	INNER JOIN Н_ЛЮДИ
		ON Н_ЛЮДИ.ИД = Н_УЧЕНИКИ.ЧЛВК_ИД
	INNER JOIN Н_ФОРМЫ_ОБУЧЕНИЯ
		ON Н_ФОРМЫ_ОБУЧЕНИЯ.ИД = Н_ПЛАНЫ.ФО_ИД
WHERE 
	-- 2012 никого не было, поменял на 2011:
	 Н_ПЛАНЫ.ФО_ИД = 1 

	AND EXISTS (
		SELECT 1
		FROM Н_ПЛАНЫ
		WHERE 
			Н_ПЛАНЫ.ИД = Н_УЧЕНИКИ.ПЛАН_ИД 
			AND Н_ПЛАНЫ.УЧЕБНЫЙ_ГОД = '2011/2012'
	)
```

Правильный запрос:

```sql
SELECT DISTINCT
	Н_УЧЕНИКИ.ГРУППА,
	Н_ЛЮДИ.ИД,
	Н_ЛЮДИ.ИМЯ,
	Н_ЛЮДИ.ФАМИЛИЯ,
	Н_ЛЮДИ.ОТЧЕСТВО,
	Н_ФОРМЫ_ОБУЧЕНИЯ.НАИМЕНОВАНИЕ,
	Н_ПЛАНЫ.ИД,
	Н_УЧЕНИКИ.СОСТОЯНИЕ
FROM Н_УЧЕНИКИ
	INNER JOIN Н_ПЛАНЫ
		ON Н_ПЛАНЫ.ИД = Н_УЧЕНИКИ.ПЛАН_ИД
	INNER JOIN Н_ЛЮДИ
		ON Н_ЛЮДИ.ИД = Н_УЧЕНИКИ.ЧЛВК_ИД
	INNER JOIN Н_ФОРМЫ_ОБУЧЕНИЯ
		ON Н_ФОРМЫ_ОБУЧЕНИЯ.ИД = Н_ПЛАНЫ.ФО_ИД
WHERE 
	 Н_ПЛАНЫ.ФО_ИД = 3 

	AND EXISTS (
		SELECT 1
		FROM Н_ПЛАНЫ
		WHERE 
			Н_ПЛАНЫ.ИД = Н_УЧЕНИКИ.ПЛАН_ИД 
			AND Н_ПЛАНЫ.УЧЕБНЫЙ_ГОД = '2012/2013'
	)
```

### Задание 7

Вывести список студентов, имеющих одинаковые имена, но не совпадающие ид.

Используем **SELF JOIN**:

```sql
SELECT 
	группа1.ИД AS ИД_1_ГРУППА,
	группа2.ИД AS ИД_2_ГРУППА,
	группа1.ИМЯ AS ИМЯ,
	группа1.ФАМИЛИЯ AS ФАМИЛИЯ,
	группа1.ОТЧЕСТВО AS ОТЧЕСТВО
FROM
	Н_ЛЮДИ группа1
JOIN 
	Н_ЛЮДИ группа2 ON
	группа1.ИМЯ = группа2.ИМЯ
	AND группа1.ФАМИЛИЯ = группа2.ФАМИЛИЯ
	AND группа1.ОТЧЕСТВО = группа2.ОТЧЕСТВО
	AND группа2.ИД <> группа1.ИД
;
```

```
ИД_1_ГРУППА | ИД_2_ГРУППА |    ИМЯ    | ФАМИЛИЯ  |   ОТЧЕСТВО      
-------------+-------------+-----------+----------+--------------  
     148761 |      130689 | Александр | Кузнецов | Владимирович  
     130689 |      148761 | Александр | Кузнецов | Владимирович  
     116023 |      129305 | Александр | Наумов   | Сергеевич  
     129305 |      116023 | Александр | Наумов   | Сергеевич  
     120236 |      116669 | Андрей    | Елисеев  | Владимирович  
     116669 |      120236 | Андрей    | Елисеев  | Владимирович  
     113577 |      152097 | Андрей    | Смирнов  | Владимирович  
     152097 |      113577 | Андрей    | Смирнов  | Владимирович  
     142007 |      157188 | Михаил    | Орлов    | Викторовна  
     157188 |      142007 | Михаил    | Орлов    | Викторовна
```